trigger:
  batch: false
  branches:
    include:
      - develop
      - mainn

pr:
   branches:
     include:
     - mainn
     - develop

pool:
  vmImage: 'ubuntu-latest'


variables:
  - group: demo
  - name: adf_code_path
    value: "$(Build.SourcesDirectory)/data_ops/adf"
  - name: adf_package_file_path
    value: "$(Build.SourcesDirectory)/build/"


# Installs Node and the npm packages saved in your package.json files in the .pipelines folder
stages:
  # - stage: Validate_ADF_Code
  #   pool:
  #     vmImage: 'windows-latest'
  #   jobs:
  #   - job: Build_ADF_Code
  #     displayName: 'Validating the ADF Code'
  #     steps:
  #     - task: BuildADFTask@1
  #       inputs:
  #         DataFactoryCodePath: '$(adf_code_path)'
  #         Action: 'Build'
  #       continueOnError: true

  - stage: Build_And_Publish_ADF_Artifacts
    
    jobs:
    - job: Build_Adf_Arm_Templates
      displayName: 'Generate ADF Artifacts'
      steps:

      - task: NodeTool@0
        inputs:
          versionSpec: '10.x'
        displayName: 'Install Node.js'

      - task: Npm@1
        inputs:
          command: 'install'
          workingDir: '$(adf_package_file_path)'
          verbose: true
        displayName: 'Install npm package'


      - task: Npm@1
        inputs:
          command: 'custom'
          workingDir: '$(adf_package_file_path)'

          customCommand: 'run build validate $(adf_code_path) /subscriptions/$(azure_subscription_id)/resourceGroups/$(resource_group_name)/providers/Microsoft.DataFactory/factories/$(azure_data_factory_name)' # Change "ADFIntegration" to the name of your root folder, if there is not root folder, remove that part and keep Build.Repository.LocalPath only.

        displayName: 'Validate'

      - task: Npm@1
        inputs:
          command: 'custom'
          workingDir: '$(adf_package_file_path)'

          customCommand: 'run build export $(adf_code_path) /subscriptions/$(azure_subscription_id)/resourceGroups/$(resource_group_name)/providers/Microsoft.DataFactory/factories/$(azure_data_factory_name) "ArmTemplate"'  # Change "ADFIntegration" to the name of your root folder, if there is not root folder, remove that part.


        displayName: 'Validate and Generate ARM template'


      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: '$(Build.SourcesDirectory)/build/ArmTemplate'
          artifact: 'adf-artifact-$(Build.BuildNumber)'
          publishLocation: 'pipeline'

  - stage: Deploy_to_Dev
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['build.SourceBranchName'], 'develop'))
    displayName: Deploy Dev Stage
    dependsOn: Build_And_Publish_ADF_Artifacts
    jobs: 
      - job: Deploy_Dev
        displayName: 'Deployment - PreProd'
        steps:
        - task: DownloadPipelineArtifact@2
          displayName: Download Build Artifacts - ADF ARM templates
          inputs: 
            artifactName: 'adf-artifact-$(Build.BuildNumber)'
            targetPath: '$(Pipeline.Workspace)/adf-artifact-$(Build.BuildNumber)'

        # - task: toggle-adf-trigger@2
        #   inputs:
        #     azureSubscription: '$(azure_service_connection_name)'
        #     ResourceGroupName: '$(resource_group_name)'
        #     DatafactoryName: '$(azure_data_factory_name)'
        #     TriggerFilter: 'RPRS_Dataload_TR'
        #     TriggerStatus: 'stop'

        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(azure_service_connection_name)'
            subscriptionId: '$(azure_subscription_id)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(resource_group_name)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: '$(Pipeline.Workspace)/adf-artifact-$(Build.BuildNumber)/ARMTemplateForFactory.json'
            csmParametersFile: '$(Pipeline.Workspace)/adf-artifact-$(Build.BuildNumber)/ARMTemplateParametersForFactory.json'
            # overrideParameters: '-factoryName $(azure_data_factory_name) -LS_ACAI_DW_connectionString $(dw_connection_string) -LS_RPRS_AKV_properties_typeProperties_baseUrl "https://$(azure_keyvault_name).vault.azure.net/" -LS_RPRS_Datalake001_properties_typeProperties_url "https://$(azure_storage_account_name).dfs.core.windows.net/" -LS_ADB_DBW01_properties_typeProperties_existingClusterId $(azure_databricks_cluster_id) -LS_ADB_DBW01_properties_typeProperties_domain $(azure_databricks_workspace_url) -LS_ADB_DBW01_properties_typeProperties_workspaceResourceId "/subscriptions/$(azure_subscription_id)/resourceGroups/$(resource_group_name)/providers/Microsoft.Databricks/workspaces/$(azure_databricks_name)" -TR_Bronze_ACAI_BLOB_properties_typeProperties_scope "/subscriptions/$(azure_subscription_id)/resourceGroups/$(resource_group_name)/providers/Microsoft.Storage/storageAccounts/$(azure_storage_account_name)"'
            deploymentMode: 'Incremental'

        # - task: toggle-adf-trigger@2
        #   inputs:
        #     azureSubscription: '$(azure_service_connection_name)'
        #     ResourceGroupName: '$(resource_group_name)'
        #     DatafactoryName: '$(azure_data_factory_name)'
        #     TriggerFilter: 'RPRS_Dataload_TR'
        #     TriggerStatus: 'start'

  - stage: Deploy_to_PreProd
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['build.SourceBranchName'], 'mainn'))
    displayName: Deploy Pre Prod Stage
    dependsOn: Build_And_Publish_ADF_Artifacts
    jobs: 
      - job: Deploy_PreProd
        displayName: 'Deployment - PreProd'
        steps:
        - task: DownloadPipelineArtifact@2
          displayName: Download Build Artifacts - ADF ARM templates
          inputs: 
            artifactName: 'adf-artifact-$(Build.BuildNumber)'
            targetPath: '$(Pipeline.Workspace)/adf-artifact-$(Build.BuildNumber)'

        # - task: toggle-adf-trigger@2
        #   inputs:
        #     azureSubscription: '$(azure_service_connection_name)'
        #     ResourceGroupName: '$(resource_group_name)'
        #     DatafactoryName: '$(azure_data_factory_name)'
        #     TriggerFilter: 'RPRS_Dataload_TR'
        #     TriggerStatus: 'stop'

        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '$(azure_service_connection_name)'
            subscriptionId: '$(azure_subscription_id)'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '$(resource_group_name)'
            location: '$(location)'
            templateLocation: 'Linked artifact'
            csmFile: '$(Pipeline.Workspace)/adf-artifact-$(Build.BuildNumber)/ARMTemplateForFactory.json'
            csmParametersFile: '$(Pipeline.Workspace)/adf-artifact-$(Build.BuildNumber)/ARMTemplateParametersForFactory.json'
            # overrideParameters: '-factoryName $(azure_data_factory_name) -LS_ACAI_DW_connectionString $(dw_connection_string) -LS_RPRS_AKV_properties_typeProperties_baseUrl "https://$(azure_keyvault_name).vault.azure.net/" -LS_RPRS_Datalake001_properties_typeProperties_url "https://$(azure_storage_account_name).dfs.core.windows.net/" -LS_ADB_DBW01_properties_typeProperties_existingClusterId $(azure_databricks_cluster_id) -LS_ADB_DBW01_properties_typeProperties_domain $(azure_databricks_workspace_url) -LS_ADB_DBW01_properties_typeProperties_workspaceResourceId "/subscriptions/$(azure_subscription_id)/resourceGroups/$(resource_group_name)/providers/Microsoft.Databricks/workspaces/$(azure_databricks_name)" -TR_Bronze_ACAI_BLOB_properties_typeProperties_scope "/subscriptions/$(azure_subscription_id)/resourceGroups/$(resource_group_name)/providers/Microsoft.Storage/storageAccounts/$(azure_storage_account_name)"'
            overrideParameters: '-factoryName "adf-deploy-stage"'
            deploymentMode: 'Incremental'

        # - task: toggle-adf-trigger@2
        #   inputs:
        #     azureSubscription: '$(azure_service_connection_name)'
        #     ResourceGroupName: '$(resource_group_name)'
        #     DatafactoryName: '$(azure_data_factory_name)'
        #     TriggerFilter: 'RPRS_Dataload_TR'
        #     TriggerStatus: 'start'
